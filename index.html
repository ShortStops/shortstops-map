<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShortStops Travel Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }
    .legend {
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      max-width: 260px;
    }
    .legend .row { display: flex; align-items: center; gap: 8px; margin-top: 6px; }
    .swatch { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.2); }
    .note { font-size: 12px; color: #444; margin-top: 8px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <script>
    // ==========================
    // Your visited data (ISO-3 codes)
    // ==========================
    // Notes:
    // - UK is treated as United Kingdom (GBR). England/Wales/Scotland/Northern Ireland are not separate countries in most world GeoJSONs.
    // - Some territories are not present in standard country datasets. We add those as markers below.
    const visited = {
      "PHL": "2011, 2013, 2015, 2017, 2019, 2022, 2023, Dec 2023, 2024, 2025",
      "GBR": "Home base (years not listed)",
      "FRA": "2016, 2017, 2025",
      "CHE": "2016, 2025",
      "ITA": "2016, 2020, 2025",
      "DEU": "2016, 2017, 2019, 2022, 2025",
      "NLD": "2016, 2019",
      "BEL": "2016, 2017, 2018, 2019, 2022, 2024",
      "AUT": "2017, 2025",
      "SVN": "2017",
      "HRV": "2017",
      "BIH": "2017",
      "SRB": "2017, 2024",
      "HUN": "2017",
      "CZE": "2017",
      "SVK": "2017",
      "ESP": "2018, 2019, 2024",
      "FIN": "2019",
      "EST": "2019",
      "LVA": "2019",
      "LTU": "2019",
      "BLR": "2019",
      "POL": "2019",
      "MCO": "2020",
      "TUR": "2022",
      "DNK": "2022",
      "IRL": "2023",
      "NOR": "2023",
      "ALB": "2023",
      "XKX": "2023",   // Kosovo is sometimes XKX, sometimes missing. We handle it gracefully.
      "MKD": "2023",
      "MYS": "2023",
      "SGP": "2023",
      "MLT": "2024",
      "GRC": "2024",
      "ROU": "2024",
      "BGR": "2024",
      "PRT": "2024",
      "MAR": "2024",
      "LUX": "2024",
      "TUN": "2025",
      "AND": "2025",
      "CYP": "2025",
      "SMR": "2025",
      "LIE": "2025",
      "BRB": "2025",
      "ATG": "2025",
      "LCA": "2025",
      "GRD": "2025",
      "KNA": "2025",
      "VGB": "2025" // British Virgin Islands (often territory, may not exist in world country layer)
    };

    // Territories and special cases that may not appear as polygons in a standard country dataset.
    // We show them as markers with popups so they still count and show up nicely.
    const territoryMarkers = [
      { name: "Vatican City", years: "2016", lat: 41.9029, lng: 12.4534 },
      { name: "Northern Ireland", years: "2023", lat: 54.5973, lng: -5.9301 },
      { name: "Northern Cyprus", years: "2025", lat: 35.1856, lng: 33.3823 },
      { name: "Sint Maarten", years: "2025", lat: 18.0425, lng: -63.0548 },
      { name: "Saint-Martin", years: "2025", lat: 18.0708, lng: -63.0501 },
      { name: "Martinique", years: "2025", lat: 14.6415, lng: -61.0242 }
    ];

    // ==========================
    // Map setup
    // ==========================
    const map = L.map("map", { zoomControl: true }).setView([20, 0], 2);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Styling
    function baseStyle(feature) {
      const iso3 = (feature.properties.ISO_A3 || feature.properties.iso_a3 || feature.id || "").toUpperCase();
      const isVisited = !!visited[iso3];

      return {
        weight: 1,
        opacity: 1,
        color: isVisited ? "#1f2937" : "#6b7280",
        fillOpacity: isVisited ? 0.55 : 0.12,
        fillColor: isVisited ? "#0ea5e9" : "#cbd5e1"
      };
    }

    function highlightStyle(feature) {
      return {
        weight: 2,
        color: "#111827",
        fillOpacity: 0.75
      };
    }

    let geojsonLayer;

    function onEachFeature(feature, layer) {
      const iso3 = (feature.properties.ISO_A3 || feature.properties.iso_a3 || feature.id || "").toUpperCase();
      const name = feature.properties.ADMIN || feature.properties.name || "Unknown";
      const years = visited[iso3];

      layer.on({
        mouseover: (e) => {
          e.target.setStyle(highlightStyle(feature));
          e.target.bringToFront();
        },
        mouseout: (e) => {
          geojsonLayer.resetStyle(e.target);
        }
      });

      if (years) {
        layer.bindPopup(`<strong>${name}</strong><br/>Visited: ${years}`);
        layer.bindTooltip(`${name}`, { sticky: true });
      }
    }

    // ==========================
    // Load world countries GeoJSON
    // ==========================
    // This dataset is lightweight and usually includes ISO_A3.
    // If GitHub is blocked on a network, host the GeoJSON in the same folder later.
    const GEOJSON_URL = "https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson";

    fetch(GEOJSON_URL)
      .then(res => {
        if (!res.ok) throw new Error("GeoJSON fetch failed");
        return res.json();
      })
      .then(data => {
        geojsonLayer = L.geoJSON(data, {
          style: baseStyle,
          onEachFeature
        }).addTo(map);

        // Add territory markers
        territoryMarkers.forEach(t => {
          L.circleMarker([t.lat, t.lng], {
            radius: 6,
            weight: 2,
            color: "#111827",
            fillColor: "#f97316",
            fillOpacity: 0.9
          })
          .addTo(map)
          .bindPopup(`<strong>${t.name}</strong><br/>Visited: ${t.years}`);
        });
      })
      .catch(err => {
        console.error(err);
        alert("Map data failed to load. If you are offline or GitHub is blocked, host the GeoJSON file locally.");
      });

    // ==========================
    // Legend
    // ==========================
    const legend = L.control({ position: "topright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = `
        <div><strong>ShortStops Travel Map</strong></div>
        <div class="row"><span class="swatch" style="background:#0ea5e9;"></span> Visited</div>
        <div class="row"><span class="swatch" style="background:#cbd5e1;"></span> Not visited</div>
        <div class="row"><span class="swatch" style="background:#f97316;"></span> Territories (marker)</div>
        <div class="note">
          Click a shaded country to see years visited. Some territories are shown as markers.
        </div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
